name: ðŸ“± Build Android APK (No Buildozer)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-apk:
    name: ðŸ”¨ Build APK with python-for-android
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: âš™ï¸ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip zip openjdk-17-jdk wget libffi-dev libssl-dev

      - name: âœ… Accept Android SDK Licenses
        run: |
          mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-preview-license

      - name: ðŸ“¥ Install Android SDK manually
        run: |
          SDK_DIR="$HOME/.buildozer/android/platform/android-sdk"
          mkdir -p "$SDK_DIR/cmdline-tools"
          cd "$SDK_DIR/cmdline-tools"
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline.zip
          unzip cmdline.zip
          mv cmdline-tools latest
          cd "$SDK_DIR"
          ln -s cmdline-tools/latest tools
          yes | "$SDK_DIR/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK_DIR" \
            "platform-tools" \
            "platforms;android-30" \
            "build-tools;34.0.0" \
            "ndk;25.2.9519653"

      - name: ðŸ“¦ Install python-for-android
        run: |
          pip install --upgrade pip setuptools
          pip install python-for-android

      - name: ðŸš€ Run your APK build command
        run: |
          echo "ðŸ”¨ Building APK with python-for-android..."

          export ANDROIDSDK="$HOME/.buildozer/android/platform/android-sdk"
          export ANDROIDNDK="$ANDROIDSDK/ndk/25.2.9519653"
          export ANDROIDAPI=30
          export ANDROIDMINAPI=21

          p4a apk \
            --private . \
            --package=com.venkat.numbergame \
            --name "NumberGuess" \
            --version 1.0 \
            --bootstrap=sdl2 \
            --sdk_dir="$ANDROIDSDK" \
            --ndk_dir="$ANDROIDNDK" \
            --android_api=$ANDROIDAPI \
            --requirements=python3,kivy,requests,json,sqlite3 \
            --arch=armeabi-v7a \
            --output dist/MyApp.apk \
            --release

      - name: ðŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyApp-APK
          path: dist/MyApp.apk
